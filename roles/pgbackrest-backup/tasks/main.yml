- name: Editing pgbackrest.conf file
  sudo: yes
  template:
      src=pgbackrest.conf.j2
      dest=/etc/pgbackrest.conf

- name: Start PostgreSQL
  service:
    name=postgresql-{{ postgres_version }}
    state=running
  ignore_errors: true
  
- name: create full backup
  sudo: yes
  shell: sudo -u postgres pgbackrest --stanza=demo --type=full --log-level-console=info backup 2>>{{ logfile }}
  when: strategy == "full"

- name: create incremental backup
  sudo: yes
  shell: sudo -u postgres pgbackrest --stanza=demo --type=incr --log-level-console=info backup 2>>{{ logfile }}
  when: strategy == "incr"

- name: create bookeeping file
  sudo: yes
  shell: pgbackrest info  | grep "incr backup\|backup reference list\|full backup" 1>> {{ bookeeping }}
