- name: Install python-gdata
  yum: name="{{ python_gdata_rpm_location }}" state=present

- name: install nonblockingloghandler
  pip: name=nonblockingloghandler state=present

- name: Install postgresql yum repository
  yum: name="{{ postgres_yum_repo }}" state=present

- name: Install openerp from bahmni-repo
  yum: name="bahmni-erp-{{ bahmni_erp_version }}" state=present

- name: Copy openerp server template
  template: src=openerp-server.conf.j2 dest=/etc/openerp/openerp-server.conf owner=openerp group=openerp mode=0655

- name: Get matched IpTable rule
  shell: iptables -nL --line-numbers | grep BAHMNIERP  -m 1 | cut -c 1-2
  register: matchedRule

- name: delete matching rule if exists
  shell: iptables -D INPUT {{ matchedRule.stdout }}
  when: matchedRule.stdout!=""

- name: Allow openmrs port through firewall
  command: /sbin/iptables -I INPUT 1 -p tcp --dport  {{ openerp_port }} -j ACCEPT -m comment --comment "BAHMNIERP"

- name: save iptables
  command: service iptables save

- name: Switch off chkconfig for Openerp on passive
  service: name=openerp state=stopped enabled=no
  when: passive is defined and passive == 'yes'

- name: Stop Openerp
  service:
    name=openerp
    state=stopped
  when: passive is not defined or passive != 'yes'
  tags: stop_bahmni

- name: Start Openerp and enable at boot
  service:
    name=openerp
    enabled=yes
    state=started
  when: passive is not defined or passive != 'yes'
  tags: start_bahmni


